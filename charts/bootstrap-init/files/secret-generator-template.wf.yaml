---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: secret-template
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "150"
    #"helm.sh/hook-delete-policy": before-hook-creation
spec:
  entrypoint: main
  securityContext:
    runAsNonRoot: true
    runAsUser: 10010
  arguments:
    parameters:
      - name: name
        value: ""
      - name: key
        value: ""
      - name: namespaces
        value: |
          []
  ############# Workflow Definition #################
  templates:
  - name: main
    steps:
    - - name: secrets
        template: secret
        arguments:
          parameters:
          - name: name
            value: "{{workflow.parameters.name}}"
          - name: namespace
            value: "{{item}}"
          - name: key
            value: "{{workflow.parameters.key}}"
        withParam: "{{workflow.parameters.namespaces}}"

############# Workflow Step Definitions #################

  - name: secret
    inputs:
      parameters:
      - name: name
      - name: namespace
      - name: key
    resource:
      action: apply
      manifest: |
        apiVersion: v1
        kind: Secret
        metadata:
          name: {{inputs.parameters.name}}
          namespace: {{inputs.parameters.namespace}}
        type: Opaque
        stringData:
          {{inputs.parameters.key}}: "dummyval"